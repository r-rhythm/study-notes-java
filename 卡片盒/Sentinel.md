# 简介
> [!info] Sentinel
> * 服务降级
> * 服务熔断
> * 服务限流
> * 比 [[Hystrix]] 更简单, 更强大

*sentinel 分为两部分, 核心库与控制台*

# 控制台
1. 使用 `java -Dserver.port=8088 -jar sentinelxxx` 可以修改端口号并启动, 使用 localhost: 8088 访问, 账号密码 sentinel
2. 在项目中应用, 并在配置文件中添加 sentinel 相关配置
```yaml
spring
	sentinel:
	
	      transport:
	
	        dashboard: localhost:8080
	
	        port: 8719  #默认8719，应用与Sentinel控制台交互的端口，应用本地会起一个该端口占用HttpServer
```

# 流控规则
- QPS: 每秒查询率 (每秒能处理多少请求)
- 线程数: 最大支持线程连接数

## 流控模式
* 直接: 对当前请求路径流控
* 关联: 当关联的资源达到阈值时, 就限流自己
* 链路

## 流控效果
* 快速失败: 超过阈值后不再处理, 直接抛出异常
* Warm Up (*预热*): 让系统缓慢提高访问处理量直至阈值, 避免冷启动突然的大流量压垮系统, 
* 排队等待: 让阈值外的请求等待

# 降级规则
- 慢调用比例：约定一个最长调用响应时间 RT, 请求响应时长大于该值称为慢调用。一旦慢调用达到约定的比例, 则接下来熔断时间内的请求会被自动熔断。经过熔断时长后，会进入探测恢复状态，若接下来的一个请求响应时间小于设置的慢调用阈值，则结束熔断。
- 异常比例：对服务设置最小请求数目和异常比例，当在约定时长内请求数目大于最小请求数且异常比例超出异常比例阈值，则触发熔断。经过熔断时长后，会进入探测恢复状态。若接下来的一个请求完成（未发生异常）则熔断结束
- 异常数：在约定时长内，异常数目超过设置的阈值后熔断服务。经过熔断时长后，会进入探测恢复状态, 若接下来的一个请求完成则结束熔断，否则会被再次熔断。

# 热点 key 限流
在控制台实现
- 在 sentinel 控制台点击热点规则 -> 新增热点规则
- 资源名: 访问的资源名或路径
- 参数索引: 设置 uri 中哪个参数来作为热点值 (从 0 开始) 判断
- 参数值: 具体的热点值

使用 Java 代码实现热点值流控
1. 在 Controller 接口中添加一个构造器, 构造器执行时调用初始化规则方法
2. 通过调用 `FlowRuleManager.loadRules()` 方法来用硬编码的方式定义流量控制规则[参阅官方文档](https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.html)


# 系统保护规则 (*面试常问*)
*系统保护规则是从多个维度监控应用指标, 让系统尽可能的在最大吞吐量与稳定性之间找到平衡*
1. Load 自适应 (*仅对类 Unix 机器生效*): 根据系统的性能指标自动设置阈值, 达到阈值后触发系统保护
2. CPU 使用率 (*CPU usage*): 当 CPU 使用率超过设定的阈值时触发系统保护 (取值范围 0~1)
4. 平均 RT (*响应时间*): 单台机器上所有入口流量的平均响应时间超出设定的阈值触发保护机制
5. 并发线程数: 单台机器所处理的并发数达到阈值后触发保护
6. 入口 QPS: 单台机器入口流量超过阈值触发系统保护


# 服务降级 @SentinelResource
- 使用 `@SentinelResource(value="方法名",blockHandlerClass=Clazz.class,blockHandler="兜底方法")` 为某个方法设置一个兜底方法
- **兜底的方法要添加一个 BlockException 参数**, 否则不会执行
- 使用 [[OpenFeign]] 时, 在远程调用服务的 `EnableFeignClient(value=服务名,fallback=回滚实现类)` 注解中接口上指定兜底的业务处理


# 规则持久化
重启后规则仍然存在, 将配置文件持久化到 nacos 配置中心
1. 依赖添加 sentinel-datasource-nacos
2. 配置文件 sentinel 下中添加 datasource, 设置 nacos 地址
3. 在 nacos 配置中心配置规则内容