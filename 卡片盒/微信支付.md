# 介绍
要使用微信支付,需要先注册微信公众号服务号,注册审核通过后会获得如下许可信息
1. appid 公众号id
2. partner 商户号
3. partnerkey 商户密钥

# 流程
1. 用户点击支付按钮后,开始加载微信支付二维码
	1. 调用微信接口,生成并返回二维码地址
	2. 往支付记录表中添加一条正在支付的支付记录
3. 用户扫码进行支付后,进行确认状态操作
	1. 第一种方式,主动确认:支付完成后,主动调用微信查询支付状态的接口,根据它返回的数据进行进一步操作,**信息返回为空代表支付失败**
	2. 第二种方式,在微信公众号后台配置支付成功后的回调地址,用户支付成功后微信自动调用这个配置的地址
3. 支付成功后,更新订单的状态
	1. 订单表中的状态修改为已支付
	2. 支付记录表中的支付状态修改为已支付

# 补充
- 微信支付成功后,微信返回的数据中会有一个 **transaction_id** 字段,它是微信方的唯一交易号,只能通过它来进行微信退款

# 注意事项
- 与[[用户登录模块]]不同的是,它使用 Post 方式进行提交
- 微信支付返回 XML 格式的数据,也支持返回 Json 数据
- 使用[[乐观锁]]保证订单不会被重复支付,微信支付已经做了相关处理,不用我们手动实现,他的原理类似于[[消息队列 Message Queue#消息幂等性保障]]

# 支付二维码分类
- 不带金额的二维码,需要用户自己手动输入要支付金额的二维码
- 附带支付金额的二维码,用户扫码二维码后支付指定的金额
