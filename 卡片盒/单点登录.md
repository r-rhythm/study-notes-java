# 概述
- 在[[SpringCloud#微服务|微服务]]架构中, 只要在一个程序的任意服务中登录, 就能在其他服务中获取到这个登录的状态与信息
- 在一个相互信任的系统中, 只需要在一个服务中登陆, 其他服务也能同步获取这个登录的状态信息
# 较为常见的实现方式
1. 使用 session 广播
2. 使用 [[Redis]] + [[Cookie]] 实现
3. 基于 token 实现
## Session 广播
- 就是 session 复制, 将单一服务的 session 复制到多个服务中, 使各个服务都能获得用户信息
- 它类似于保证 session 一致性问题的 **session 同步** 解决方案 [[框架高级#9. Session 一致性的几种解决方案？]]
## ==Redis + Cookie 实现==
1. 当用户在微服务项目的某个模块登录后, 系统返回用户相关的用户信息, 将这个返回信息分别存储到 Redis 与 cookie 中
2. Redis 中的 key 按照一定的规则 (*保证每个用户唯一*) 生成唯一的字符串, value 存储用户信息 (*名称, id 等*)
3. 操作 cookie , 将 Redis 内的 key 放到 cookie 中进行存储
4. 当用户再去访问系统的其他服务模块, 每次请求时都携带这个 cookie, 在后端获取 cookie 的值, 使用这个值去 redis 中查询, 如果能查询到即登录状态
5. 通过设置 Redis 数据过期时间, 完成对单点登录有效时长的控制
注意
- Cookie 是不能跨域传递的, 但在微服务系统中, 要实现单点登录就需要对其进行特别的处理, 解决方案: [[Cookie#Cookie 如何跨域传递]]   


# ==基于 token 实现==
## 什么是 token
- Token (*自包含令牌*) 就是一个字符串, 这个字符串中可以包含用户信息, 可以对这个字符串进行加密编码处理
- Token 字符串可以自己约定规则生成, 也可以使用一些其他工具来生成, 例如 JWT[^JWT] 等
- 在用户请求登录, 访问到用户中心登录成功后, 使用私钥给他的信息进行加密生成 token, 用户在访问其他服务时携带这个 token, 其他服务通过公钥来解密这个 token, 从而获得用户登录状态
## Token 实现单点登录
第一种
1. 用户访问某个模块进行登录, 这个模块生成 token 字符串 (*加密后*), 并把字符串返回存储到 cookie
2. 再次请求系统时携带 cookie, 其他服务获取 cookie 值, 将 token 字符串解密, 判断是否包含用户信息, 如果包含则为登录状态

第二种
1. 同第一种方式相比, 不使用 cookie 存储
2. 每次访问时将 token 使用 uri 地址栏进行传递
---
[^JWT]: Json Web Token, 用来生成 token 的工具, 它由**公共部分、私有部分、签名部分**三个部分组成。最后由这三者组合进行 base64 编码得到 JWT。私钥加密, 公钥解密
