# 订单支付
## 流程分析
1. 前端处理,每隔三秒调用一次查询微信支付状态的接口
2. 后端根据订单 id 查询支付状态,根据微信接口返回的状态决定后续处理
    1. 调用微信接口,查询订单的支付状态
        1. 携带的参数
            2. appid
            3. 商户号
            4. 交易号
            5. 随机字符串
    2. 根据微信接口返回的状态,决定后续处理

## 实现
- 支付成功
    - 微信的返回信息中有一个 `trade_state` 字段,如果为 SUCCESS 即为支付成功
    - 从微信返回的信息中获得订单的交易号 `out_trade_no` 更新订单表中状态和支付记录状态为已成功
    - 返回的参数
            1. **transaction_id** 微信返回的交易号,在微信退款时会用到
- 支付失败
    - 微信接口不会返回任何信息
# 取消预约
## 流程分析
用户点击取消预约后,执行多个判断流程
1. 判断当前时间是否已经过了取消挂号时间,如果当前时间已经过了 quit_time,则不能取消订单
2. 调用医院系统接口,进行退号,医院返回成功,继续退号
3. 判断订单的支付状态 order_status
4. 如果用户未支付,修改订单表订单状态为(*已取消*)即可
5. 如果用户已经支付
    1. 向退款记录表中添加一条记录(*退款中*)
    2. 调用微信接口进行退款,通过 *transaction_id*
    3. 修改订单表订单状态(*已取消*)
    4. 修改退款记录表记录状态为(*已退款*)
## 实现
取消预约准备工作
- 微信退款,需要使用证书
- 安装证书(在项目中加载安装)
    1. 把证书文件放到本地目录中
    2. 在项目的配置文件中添加配置信息 `weixin.cert=证书路径 `
    3. 读取这个配置数据 [[SpringBoot#获取配置文件中的参数]]
    4. 若退款失败报错 ssl 或 security 可能是由于 jdk 版本问题

具体实现
1. 根据 orderId 查询订单信息
2. 判断当前时间是否已经过了规定的退号时间
3. 调用医院系统退号接口,进行退号
    1. 根据医院的返回值决定后续的流程
2. 医院接口返回成功
    1. 判断当前的订单是否已经支付,没有支付直接修改状态
    2. 如果已经支付,进行微信退款,成功后修改三张表的状态
    3. 取消预约成功,使用 RabbitMQ 发送消息,更新号源数量
    4. 接口记得返回 true
# 就医提醒
- 使用 [[SpringSchedule]] 模块设置定时任务,实现定时发送短信提醒就医功能
